# 垃圾回收

## 垃圾回收概述

### 什么是垃圾

- 垃圾是指在运行程序中没有任何指针指向的对象，这个对象就是需要被回收的垃圾。

- 如果不及时对内存中的垃圾进行清理，那么这些垃圾对象所占的内存空间会一直保留到应用程序结束，被保留的空间无法被其他对象使用。甚至可能导致**内存溢出**。

### 为什么需要GC

- 对于高级语言而讲，如果不进行垃圾回收，内存迟早都会被消耗完，因为不断地分配内存空间而不进行回收，就好像不停地生产生活垃圾而从不打扫一样。
- 除了释放没用的对象，垃圾回收也可以清除内存里的记录碎片。碎片整理将所占用的堆内存移到堆的一端，以便JVM将整理出的内存分配给新的对象。
- 随着应用程序所应付的业务越来越大、复杂，用户越来越多，没有GC就不能保证应用程序的正常进行。而经常造成STW的GC又跟不上实际的需求，所以才会不断地尝试对GC进行优化。

## 垃圾回收相关算法

判断对象存活一般有两种方式：引用计数算法和可达性分析算法。

### 标记阶段：引用计数算法

- 对每个对象保存一个整型的引用计数器属性。用于记录对象被应用的情况。

- 对一个对象A，只要有任何一个对象引用了A，则A的引用计数器就加1；当引用失效时，引用计数器就减1。只要对象A的引用计数器的值为0，表示对象A不可能再被使用，可进行回收。
- 优点：实现简单，垃圾对象便于辨识；判定效率高，回收没有延迟性。
- 缺点：
  - 它需要单独得到字段存储计数器，这样的做法增加了存储空间的开销。
  - 每次赋值都需要更新计数器，伴随着加法和减法操作，这增加了时间开销。
  - 引用计数器有一个严重的问题，**无法处理循环引用**的情况。
- 引用计数算法是很多语言的资源回收选择，例如python，它更是支持引用计数和垃圾收集机制。
- 具体哪种最优是要看场景的，业界有大规模实践中仅保留引用计数机制，以提高吞吐量的尝试。
- Java没有选择引用计数是因为它很难处理循环引用关系。
- python如何解决循环引用？
  - 手动解除：在合适的时机解除引用关系。
  - 使用弱引用weakref，weakref是python提供的标准库，旨在解决循环引用。

### 标记阶段：可达性分析算法（根搜索算法、追踪性垃圾收集）



### 对象的finalization机制



### MAT与JProfiler的GC Roots溯源



### 清除阶段：标记-清除算法



### 清除阶段：复制算法



### 清除阶段：标记-压缩算法



### 小结



### 分代收集算法



### 增量收集算法、分区算法



## 垃圾回收相关概念



## 垃圾收集器