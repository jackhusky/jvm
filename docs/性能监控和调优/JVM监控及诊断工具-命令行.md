# JVM监控及诊断工具-命令行

## 概述

Java作为最流行的编程语言之一，其应用性能诊断一直受到业界广泛关注。可能造成Java引用出现性能问题的因素很多，比如线程控制、磁盘读写、数据库访问、网络I/O、垃圾收集等。想要定位这些问题。一款优秀的性能诊断工具必不可少。

## jps：查看正在运行的Java进程

jps（Java Process Status）：显示指定系统内所有的HotSpot虚拟机进程（查看虚拟机进程信息），可用于查询正在运行的虚拟机进程。

说明：对于本地虚拟机进程来说，进程的本地虚拟机ID与操作系统的进程ID是一致的，是唯一的。

### 基本语法

jps [options] [hostid]

#### options参数

-q：仅仅显示LVMID（local vertual machine id），即本地虚拟机唯一id。不显示主类的名称等

-l：输出应用程序主类的全类名或如果进程执行的是jar包，则输出jar完整路径

-m：输出虚拟机进程启动时传递给主类main()的参数

-v：列出虚拟机进程启动时的JVM参数。

### hostid参数

RMI注册表中注册的主机名。

如果想要远程监控主机上的java程序，需要安装jstatd。

## jstat：查看JVM统计信息

jstat（JVM Statistics Monitoring Tool）是用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程虚拟机进程中的类加载、内存、垃圾收集、即时编译等运行时数据。

在没有GUI图形界面、只提供了纯文本控制台环境的服务器上，它将是运行期定位虚拟机性能问题的常用工具。

### 基本语法

```shell
jstat -<option> [-t] [-h<lines>] <vmid> [<interval> [<count>]]
```

#### option参数

- 类装载相关的：
  - -class：显示ClassLoader的相关信息：类的装载、卸载数量、总空间、类装载所消耗的时间等
- 垃圾回收相关的：
  - -gc：显示与GC相关的堆信息。包括Eden区、两个Survivor区、老年代、永久代等的容量、已用空间、GC时间合计等信息。
  - -gccapacity：显示内容与-gc基本相同，但输出主要关注Java堆各个区域使用到的最大、最小空间。
  - -gcutil：显示内容与-gc基本相同，但输出主要关注已使用空间占总空间的百分比。
  - -gccause：与-gcutil功能一样，但是会额外输出导致最后一次货当前正在发生的GC产生的原因。
  - -gcnew：显示新生代GC状况。
  - -gcnewcapacity：显示内容与-gcnew基本相同，输出主要关注使用到的最大、最小空间。
  - -geold：显示老年代GC状况。
  - -geoldcapacity：显示内容与-geold基本相同，输出主要关注使用到的最大、最小空间。
- JIT相关的：
  - -complier：显示JIT编译器编译过的方法、耗时等信息
  - -printcompilation：输出已经被JIT编译的方法

#### interval参数

用于指定输出统计数据的周期，单位为毫秒，即：查询间隔

#### count参数

用于指定查询的总次数

#### -t参数

可以在输出信息前加上一个TimeStamp列，显示程序的运行时间。单位：秒

> 我们可以比较Java进程的启动时间以及总GC时间（GCT列），或者两次测量的间隔时间以及总GC时间的增量，来得出GC时间占运行时间的比例。
>
> 如果该比例超过20%，则说明目前堆的压力较大；如果该比例超过90%，则说明堆里几乎没有可用空间，随时都可能抛出OOM异常。

#### -h参数

可以在周期性数据输出时，输出多少行数据后输出一个表头信息

#### 补充

jstat还可以用来判断是否出现内存泄漏

第1步：在长时间运行的Java程序中，我们可以运行jstat命令连续获取多行性能数据，并取这几行数据中OU列（即已占用的老年代内存）的最小值。

第2步：然后，我们每隔一段较长的时间重复一次上述操作，来获得多组OU最小值。如果这些值成上涨趋势，则说明该Java程序的老年代内存已使用量在不断上涨，这意味着无法回收的对象在不断增加，因此很有可能存在内存泄漏。